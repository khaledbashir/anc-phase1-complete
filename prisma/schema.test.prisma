generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./test.db"
}

// Test schema - same as main schema but uses SQLite
// Use this for local testing when PostgreSQL is unavailable

enum CalculationMode {
  MIRROR
  INTELLIGENCE
}

enum VerificationStatus {
  PENDING
  VERIFIED
  WARNING
  ERROR
  BLOCKED
  CUSTOM
}

enum ProposalStatus {
  DRAFT
  PENDING_VERIFICATION
  AUDIT
  APPROVED
  SHARED
  SIGNED
  CLOSED
  ARCHIVED
  CANCELLED
}

enum DocumentMode {
  BUDGET
  PROPOSAL
  LOI
}

enum ChangeRequestStatus {
  OPEN
  RESOLVED
}

model Workspace {
  id              String     @id @default(cuid())
  name            String
  clientLogo      String?
  aiWorkspaceSlug String?
  proposals       Proposal[]
  users           User[]
}

enum UserRole {
  ADMIN
  ESTIMATOR
  PRODUCT_EXPERT
  PROPOSAL_LEAD
  FINANCE
  OUTSIDER
  VIEWER
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String?
  role        UserRole  @default(VIEWER)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
}

model Proposal {
  id                    String              @id @default(cuid())
  workspaceId          String
  clientName           String
  clientLogo           String?
  clientAddress        String?
  clientCity           String?
  clientZip            String?
  venue                String?
  documentMode         DocumentMode        @default(BUDGET)
  documentConfig       Json?
  quoteItems           Json?
  paymentTerms         String?
  additionalNotes      String?
  status               ProposalStatus      @default(DRAFT)
  calculationMode      CalculationMode     @default(INTELLIGENCE)
  internalAudit        String?
  clientSummary        String?
  aiThreadId           String?
  aiWorkspaceSlug      String?
  taxRateOverride      Decimal?
  bondRateOverride     Decimal?
  shareHash            String?             @unique
  shareExpiresAt       DateTime?
  sharePasswordHash    String?
  structuralTonnage    Decimal?
  reinforcingTonnage   Decimal?
  isLocked             Boolean             @default(false)
  lockedAt             DateTime?
  documentHash         String?
  parentProposalId     String?
  versionNumber        Int                 @default(1)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @default(now()) @updatedAt
  verificationManifest   Json?
  reconciliationReport   Json?
  verificationStatus     VerificationStatus @default(PENDING)
  aiFilledFields         String[]
  verifiedFields         Json?
  lastVerifiedBy         String?
  lastVerifiedAt         DateTime?
  pricingDocument        Json?
  marginAnalysis         Json?
  parserValidationReport Json?
  sourceWorkbookHash     String?
  parserStrictVersion    String?
  specsDisplayMode       String?
  includeResponsibilityMatrix Boolean?
  responsibilityMatrix   Json?
  respMatrixFormatOverride String?
  insuranceRateOverride  Decimal?
  overheadRate           Decimal?            @default(0.10)
  profitRate             Decimal?            @default(0.05)
  signerName             String?
  signerTitle            String?
  manualOverrides       ManualOverride[]
  proposalVersions      ProposalVersion[]
  signatureAuditTrail   SignatureAuditTrail[]
  comments              Comment[]
  activityLogs          ActivityLog[]
  changeRequests        ChangeRequest[]
  versions             BidVersion[]
  workspace            Workspace           @relation(fields: [workspaceId], references: [id])
  screens              ScreenConfig[]
  snapshots            ProposalSnapshot[]
  rfpDocuments         RfpDocument[]
}

model ManualOverride {
  id              String   @id @default(cuid())
  proposalId      String
  proposal        Proposal @relation(fields: [proposalId], references: [id])
  entityType      String
  entityId        String
  field           String
  originalValue   Decimal
  overrideValue   Decimal
  reason          String
  approver        String
  createdBy       String
  createdAt       DateTime @default(now())
  
  @@index([proposalId])
}

model ProposalVersion {
  id              String   @id @default(cuid())
  proposalId      String
  proposal        Proposal @relation(fields: [proposalId], references: [id])
  versionNumber   Int
  manifest        Json
  auditData       Json
  pdfUrl          String?
  uglySheetUrl    String?
  createdAt       DateTime @default(now())
  createdBy       String
  changeReason    String
  
  @@index([proposalId])
}

model RfpDocument {
  id         String   @id @default(cuid())
  name       String
  url        String
  createdAt  DateTime @default(now())
  proposalId String?
  proposal   Proposal? @relation(fields: [proposalId], references: [id])
}

model ProposalSnapshot {
  id           String   @id @default(cuid())
  proposalId   String
  shareHash    String   @unique
  snapshotData String
  expiresAt    DateTime?
  passwordHash String?
  createdAt    DateTime @default(now())
  proposal     Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
}

model BidVersion {
  id                String   @id @default(cuid())
  proposalId        String
  versionNumber     Int
  taxRate           Decimal?
  bondRate          Decimal?
  margin            Decimal?
  totalSellingPrice Decimal?
  createdAt         DateTime @default(now())
  proposal          Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
}

model ScreenConfig {
  id         String         @id @default(cuid())
  proposalId String
  name       String
  externalName String?
  pixelPitch Float
  width      Float
  height     Float
  brightness Float?
  hiddenFromSpecs Boolean @default(false)
  quantity   Int?          @default(1)
  lineItems  CostLineItem[]
  proposal   Proposal       @relation(fields: [proposalId], references: [id])
}

model CostLineItem {
  id             String       @id @default(cuid())
  screenConfigId String
  category       String
  cost           Decimal
  margin         Decimal
  price          Decimal
  screenConfig   ScreenConfig @relation(fields: [screenConfigId], references: [id])
}

model Comment {
  id              String   @id @default(cuid())
  proposalId      String
  proposal        Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  userId          String?
  authorName      String
  content         String
  parentCommentId String?
  parentComment   Comment? @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies         Comment[] @relation("CommentReplies")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([proposalId])
}

model ChangeRequest {
  id             String              @id @default(cuid())
  proposalId     String
  proposal       Proposal            @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  shareHash      String
  requesterName  String
  requesterEmail String?
  message        String
  status         ChangeRequestStatus @default(OPEN)
  createdAt      DateTime            @default(now())
  resolvedAt     DateTime?
  resolvedBy     String?

  @@index([proposalId])
  @@index([shareHash])
}

model ActivityLog {
  id              String   @id @default(cuid())
  proposalId      String
  proposal        Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  userId          String?
  action          String
  description     String
  metadata        Json?
  createdAt       DateTime @default(now())

  @@index([proposalId])
}

model SignatureAuditTrail {
  id              String   @id @default(cuid())
  proposalId      String
  proposal        Proposal @relation(fields: [proposalId], references: [id])
  signerEmail     String
  signerName      String
  signerTitle     String?
  signerRole      String
  ipAddress       String
  userAgent       String?
  authMethod      String
  documentHash    String
  pdfHash         String?
  auditExcelHash  String?
  signedAt        DateTime @default(now())
  
  @@index([proposalId])
}
